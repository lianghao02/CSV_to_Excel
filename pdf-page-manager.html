<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF & åœ–ç‰‡ç®¡ç†èˆ‡é‡çµ„å·¥å…·ï¼ˆå«æ—‹è½‰åŠŸèƒ½ï¼‰</title>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">

  <style>
    /* å…¨åŸŸè¨­å®š */
    body {
      font-family: 'Microsoft JhengHei', sans-serif;
      font-size: 14px;
      margin: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      font-size: 1.8em;
      margin-bottom: 10px;
    }
    /* ä½¿ç”¨èªªæ˜ */
    .instructions {
      background: #fff3cd;
      border: 1px solid #ffeeba;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      color: #856404;
    }
    /* æª”æ¡ˆä¸Šå‚³å€ */
    #dropZone {
      border: 2px dashed #aaa;
      padding: 20px;
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 8px;
    }
    #dropZone.dragover {
      background: #eef6fc;
    }
    /* æ§åˆ¶å€ç¾¤çµ„ï¼ˆä¸Šå‚³èˆ‡ç·¨è¼¯æŒ‰éˆ•ï¼‰ */
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
    }
    .control-group {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex: 1 1 300px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .control-group h3 {
      width: 100%;
      margin-bottom: 8px;
      font-size: 1.1em;
      color: #0078D7;
    }
    /* æŒ‰éˆ•èˆ‡è¼¸å…¥å…ƒä»¶ */
    button,
    input[type='file'],
    input[type='text'],
    input[type='number'],
    input[type='range'] {
      font-family: 'Microsoft JhengHei', sans-serif;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #0078D7;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    button:hover:not(:disabled) {
      background: #005bb5;
    }
    button:disabled {
      background: #a0c4f0;
      cursor: not-allowed;
    }
    /* é é¢å€ */
    .area {
      margin-bottom: 20px;
    }
    .area h2 {
      margin-bottom: 10px;
      font-size: 1.3em;
      color: #0078D7;
    }
    .container {
      overflow-x: auto;
      white-space: nowrap;
      padding: 10px;
      border: 1px solid #ccc;
      min-height: 120px;
      background: #fff;
      border-radius: 8px;
    }
    /* ç¸®åœ–æ¨£å¼ï¼šé è¨­ 120px å¯¬ï¼Œé«˜åº¦ç”±åœ–ç‰‡ä¿æŒæ¯”ä¾‹è‡ªå‹• */
    .thumb {
      display: inline-block;
      vertical-align: top;
      margin-right: 10px;
      position: relative;
      width: 120px;
      height: auto;
      cursor: grab;
      user-select: none;
    }
    /* åœ–ç‰‡å¡«æ»¿å®¹å™¨ */
    .thumb img {
      display: block;
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 4px;
      transform-origin: center center;
    }
    .page-label {
      position: absolute;
      bottom: 4px;
      left: 4px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 2px 4px;
      font-size: 12px;
      border-radius: 2px;
    }
    .page-index {
      position: absolute;
      top: 4px;
      left: 4px;
      background: #ffd700;
      color: #222;
      padding: 2px 6px;
      font-size: 14px;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .delete-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      background: #e81123;
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .thumb.selected {
      outline: 3px dashed #0078D7;
      outline-offset: 2px;
    }
    .thumb:focus {
      outline: 2px dashed #0078D7;
      outline-offset: 2px;
    }
  </style>

  <!-- å¥—ä»¶è¼‰å…¥ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/plugins/SortableMultiDrag.min.js"></script>
  <script>if(window.Sortable&&window.SortableMultiDrag)Sortable.mount(new SortableMultiDrag());</script>
</head>

<body>
  <h1>PDF & åœ–ç‰‡ç®¡ç†èˆ‡é‡çµ„å·¥å…·ï¼ˆå«æ—‹è½‰åŠŸèƒ½ï¼‰</h1>

  <!-- ä¸Šå‚³å€ -->
  <div id="dropZone">
    <strong>æ‹–æ›³ PDFã€åœ–ç‰‡ æˆ–é»æ“Šæ–°å¢</strong><br>
    <input type="file" id="fileInput" accept="application/pdf,image/*" multiple style="margin-top:10px;" />
  </div>

  <!-- ç·¨è¼¯æŒ‰éˆ•ç¾¤çµ„ -->
  <div class="controls">
    <div class="control-group">
      <h3>ç·¨è¼¯åŠŸèƒ½</h3>
      <button id="insertBlankBtn">ç©ºç™½é </button>
      <button id="undoBtn">âŒ ä¸Šä¸€æ­¥</button>
      <button id="zoomOut">ğŸ”- ç¸®å°</button>
      <button id="zoomIn">ğŸ”+ æ”¾å¤§</button>
      <label>å“è³ª<input type="number" id="qualityInput" min="10" max="300" step="10" value="100" style="width:60px" /></label>
      <button id="rotateLeftBtn">âŸ² å·¦æ—‹</button>
      <button id="rotateRightBtn">âŸ³ å³æ—‹</button>
      <label>é–“è·<input type="range" id="gapRange" min="0" max="50" value="10" /></label>
      <input type="text" id="outputName" placeholder="è¼¸å‡ºæª”å" style="margin-left:10px;" />
      <button id="exportBtn" disabled>åŒ¯å‡º PDF</button>
    </div>
  </div>

  <!-- ä¸»é é¢å€ -->
  <div class="area">
    <h2>ä¸»é é¢å€</h2>
    <div id="thumbnails" class="container"></div>
  </div>

  <!-- å°‡ã€Œé é¢ç®¡ç†ã€ç¾¤çµ„æ”¾åœ¨ä¸»é é¢å€èˆ‡æš«å­˜å€ä¹‹é–“ -->
  <div class="control-group" style="justify-content:center; gap:10px; margin:20px 0;">
    <!-- æŒ‰éˆ•é †åºï¼šå·¦ã€å³ã€ä¸Šã€ä¸‹ã€åˆªé™¤ã€å–æ¶ˆ -->
    <button id="moveLeftBtn">â† å‘å·¦ç§»å‹•</button>
    <button id="moveRightBtn">â†’ å‘å³ç§»å‹•</button>
    <button id="moveToThumbnailsBtn">â†‘ ç§»å›ä¸»é é¢</button>
    <button id="moveToStagingBtn">â†“ ç§»å‹•åˆ°æš«å­˜å€</button>
    <button id="deleteSelectedBtn">ğŸ—‘ åˆªé™¤é¸å–</button>
    <button id="clearSelectBtn">Ã— å–æ¶ˆé¸å–</button>
  </div>

  <!-- æš«å­˜å€ -->
  <div class="area">
    <h2>æš«å­˜å€</h2>
    <div id="staging" class="container"></div>
  </div>

  <!-- ä½¿ç”¨èªªæ˜ï¼ˆç§»åˆ°æœ€ä¸‹æ–¹ï¼‰ -->
  <div class="instructions">
    <strong>ä½¿ç”¨èªªæ˜ï¼š</strong>
    <ul>
      <li>æ‹–æ›³ PDFã€åœ–ç‰‡ æˆ–é»æ“Šä¸Šæ–¹çš„ã€Œæ–°å¢ã€æŒ‰éˆ•</li>
      <li>é»æ“Šç¸®åœ–å¯é¸å–ï¼Œå¤šé¸è«‹æŒ‰ä½ Shift æˆ– Ctrlï¼ˆCmdï¼‰</li>
      <li>æŒ‰ã€Œâ†/â†’ã€å¯åœ¨ä¸»é é¢å€èª¿æ•´ä½ç½®ï¼Œä¹Ÿå¯ä½¿ç”¨éµç›¤æ“ä½œ</li>
      <li>æŒ‰ã€Œâ†‘ã€å¯å°‡é¸å–é é¢ç§»å›ä¸»é é¢å€</li>
      <li>æŒ‰ã€Œâ†“ã€å¯å°‡é¸å–é é¢ç§»åˆ°æš«å­˜å€</li>
      <li>æŒ‰ã€ŒğŸ—‘ åˆªé™¤é¸å–ã€å¯åˆªé™¤æ‰€é¸é é¢ï¼Œä¹Ÿå¯æŒ‰éµç›¤ Delete åˆªé™¤</li>
      <li>æŒ‰ã€ŒÃ— å–æ¶ˆé¸å–ã€å¯æ¸…ç©ºç›®å‰é¸æ“‡</li>
      <li>æŒ‰ã€ŒâŸ²/âŸ³ã€å¯æ—‹è½‰é¸å–é é¢</li>
      <li>å¯èª¿æ•´ã€Œå“è³ªã€èˆ‡ã€Œé–“è·ã€ä¾†æ”¹è®Šç¸®åœ–å¤§å°åŠé–“è·</li>
      <li>ç·¨è¼¯å®Œç•¢å¾Œï¼Œæ–¼ã€Œè¼¸å‡ºæª”åã€æ¬„ä½è¼¸å…¥æª”åï¼Œé»ã€ŒåŒ¯å‡º PDFã€å³å¯</li>
      <li>éµç›¤å¿«é€Ÿéµï¼šCtrl+Z / Cmd+Z â†’ å¾©åŸï¼›Delete â†’ åˆªé™¤ï¼›â†/â†’/â†‘/â†“ â†’ ç§»å‹•</li>
    </ul>
  </div>

  <script type="module">
    const { PDFDocument, degrees } = window.PDFLib;
    const pdfjsLib = window.pdfjsLib;
    // ä¿®æ­£ workerSrc ç‚º valid URL
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    // ä¸€æ¬¡æŠ“ DOM
    const dropZone        = document.getElementById('dropZone');
    const fileInput       = document.getElementById('fileInput');
    const thumbnails      = document.getElementById('thumbnails');
    const staging         = document.getElementById('staging');
    const insertBlankBtn  = document.getElementById('insertBlankBtn');
    const undoBtn         = document.getElementById('undoBtn');
    const zoomIn          = document.getElementById('zoomIn');
    const zoomOut         = document.getElementById('zoomOut');
    const qualityInput    = document.getElementById('qualityInput');
    const gapRange        = document.getElementById('gapRange');
    const rotateLeftBtn   = document.getElementById('rotateLeftBtn');
    const rotateRightBtn  = document.getElementById('rotateRightBtn');
    const moveLeftBtn     = document.getElementById('moveLeftBtn');
    const moveRightBtn    = document.getElementById('moveRightBtn');
    const moveToThumbnailsBtn = document.getElementById('moveToThumbnailsBtn');
    const moveToStagingBtn    = document.getElementById('moveToStagingBtn');
    const deleteSelectedBtn  = document.getElementById('deleteSelectedBtn');
    const clearSelectBtn     = document.getElementById('clearSelectBtn');
    const exportBtn         = document.getElementById('exportBtn');
    const outputName        = document.getElementById('outputName');

    const observer = new IntersectionObserver(entries => {
      entries.forEach(e => {
        if (e.isIntersecting) observer.unobserve(e.target);
      });
    }, { root: thumbnails, threshold: 0.1 });

    let fileList = [], pageList = [], undoStack = [];
    let scalePercent = 100, lastSelectedIndex = null;

    // å„²å­˜ undo ç‹€æ…‹
    const saveUndoState = () => {
      undoStack.push(JSON.stringify(pageList));
      if (undoStack.length > 20) undoStack.shift();
    };
    // å¾©åŸä¸Šä¸€æ­¥
    const undoLastAction = () => {
      if (!undoStack.length) return alert('âš ï¸ ç„¡æ“ä½œå¯å¾©åŸ');
      pageList = JSON.parse(undoStack.pop());
      renderAll();
      updateControls();
    };

    // æ›´æ–°æŒ‰éˆ•å¯ç”¨ç‹€æ…‹
    const updateControls = () => {
      const anySelectedInThumb = pageList.some(i => i.selected && i.area === 'thumbnails');
      const anySelectedInStage = pageList.some(i => i.selected && i.area === 'staging');
      deleteSelectedBtn.disabled = !pageList.some(i => i.selected);
      clearSelectBtn.disabled = !pageList.some(i => i.selected);
      // å·¦/å³ åœ¨å…©å€çš†å¯ç”¨ä¾†äº¤æ›å€å…§é †åº
      moveLeftBtn.disabled = !(anySelectedInThumb || anySelectedInStage);
      moveRightBtn.disabled = !(anySelectedInThumb || anySelectedInStage);
      // ä¸Š/ä¸‹ å‹•ä½œåªé‡å°åˆ‡æ›å€åŸŸ
      moveToThumbnailsBtn.disabled = !anySelectedInStage;
      moveToStagingBtn.disabled = !anySelectedInThumb;
      exportBtn.disabled = !pageList.some(i => i.area === 'thumbnails');
    };

    // å–æ¶ˆæ‰€æœ‰é¸å–
    const clearSelection = () => {
      pageList.forEach(i => i.selected = false);
      lastSelectedIndex = null;
      renderAll();
      updateControls();
    };

    // æ–°å¢ PDF / åœ–ç‰‡ æª”æ¡ˆ
    async function addFiles(files) {
      for (const f of files) {
        if (f.type === 'application/pdf') {
          const url = URL.createObjectURL(f);
          const pdf = await pdfjsLib.getDocument({ url }).promise;
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            await page.render({ canvasContext: context, viewport }).promise;
            const dataURL = canvas.toDataURL();

            pageList.push({
              fileType: 'pdf',
              fileIdx: fileList.length,
              pageNum: i,
              dataURL,
              area: 'thumbnails',
              originPageNum: i,
              selected: false,
              rotation: 0
            });
          }
          fileList.push(f);
          URL.revokeObjectURL(url);
        } else if (f.type.startsWith('image/')) {
          await addImageFile(f);
        }
      }
      saveUndoState();
      renderAll();
      updateControls();
    }

    // æ–°å¢å–®å¼µåœ–ç‰‡æª”æ¡ˆ
    async function addImageFile(file) {
      return new Promise(resolve => {
        const img = new Image(), url = URL.createObjectURL(file);
        img.onload = () => {
          const cv = document.createElement('canvas');
          cv.width = img.naturalWidth;
          cv.height = img.naturalHeight;
          cv.getContext('2d').drawImage(img, 0, 0);
          pageList.push({
            fileType: 'img',
            dataURL: cv.toDataURL(),
            area: 'thumbnails',
            originPageNum: file.name,
            selected: false,
            rotation: 0
          });
          URL.revokeObjectURL(url);
          resolve();
        };
        img.src = url;
      });
    }

    // æ‹–æ›³äº‹ä»¶
    dropZone.ondragover  = e => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = _ => dropZone.classList.remove('dragover');
    dropZone.ondrop      = e => { e.preventDefault(); dropZone.classList.remove('dragover'); addFiles(e.dataTransfer.files); };
    fileInput.onchange   = e => addFiles(e.target.files);

    // æ’å…¥ç©ºç™½é 
    function insertBlankPage() {
      const w = 595, h = 842;
      const scale = scalePercent / 100;
      const cv = document.createElement('canvas');
      cv.width = w * scale;
      cv.height = h * scale;
      const ctx = cv.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0, 0, cv.width, cv.height);
      ctx.strokeStyle = '#ccc';
      ctx.strokeRect(0, 0, cv.width - 1, cv.height - 1);
      ctx.font = 'bold 30px Arial';
      ctx.fillStyle = '#ccc';
      ctx.fillText('ç©ºç™½é ', cv.width / 2 - 60, cv.height / 2);

      pageList.push({
        fileIdx: -1,
        pageNum: 1,
        dataURL: cv.toDataURL(),
        area: 'thumbnails',
        originPageNum: 'ç©ºç™½',
        selected: false,
        isBlank: true,
        rotation: 0
      });
      saveUndoState();
      renderAll();
      updateControls();
    }

    // æ¸²æŸ“æ‰€æœ‰é é¢
    function renderAll() {
      thumbnails.innerHTML = '';
      staging.innerHTML = '';
      let num = 1;
      pageList.forEach(i => { if (i.area === 'thumbnails') i.mainPageIdx = num++; });
      pageList.forEach((i, idx) => {
        const el = document.createElement('div');
        el.className = 'thumb';
        el.dataset.idx = idx;
        el.tabIndex = 0;
        if (i.selected) el.classList.add('selected');
        const baseW = 120;
        const baseH = baseW * (842 / 595);
        const scale = scalePercent / 100;
        const isRotated = i.rotation % 180 !== 0;
        const w = isRotated ? baseH : baseW;
        const h = isRotated ? baseW : baseH;
        el.style.width = `${w * scale}px`;
        el.style.height = `${h * scale}px`;
        const img = new Image();
        img.src = i.dataURL;
        img.style.transform = `rotate(${i.rotation}deg)`;
        img.style.width = '100%';
        img.style.height = '100%';
        el.appendChild(img);
        const lbl = document.createElement('div');
        lbl.className = 'page-label';
        if (i.isBlank) lbl.textContent = 'ç©ºç™½é ';
        else if (i.fileType === 'pdf') lbl.textContent = `æª”${i.fileIdx + 1}-é ${i.originPageNum}`;
        else lbl.textContent = 'åœ–ç‰‡';
        el.appendChild(lbl);
        if (i.area === 'thumbnails') {
          const idxLbl = document.createElement('div');
          idxLbl.className = 'page-index';
          idxLbl.textContent = i.mainPageIdx;
          el.appendChild(idxLbl);
        }
        const del = document.createElement('button');
        del.className = 'delete-btn';
        del.textContent = 'Ã—';
        del.onclick = e => { e.stopPropagation(); saveUndoState(); pageList.splice(idx, 1); renderAll(); updateControls(); };
        el.appendChild(del);
        el.onclick = e => {
          if (e.target === del) return;
          if (e.shiftKey && lastSelectedIndex !== null) {
            const s = Math.min(lastSelectedIndex, idx), eI = Math.max(lastSelectedIndex, idx);
            for (let j = s; j <= eI; j++) if (pageList[j].area === i.area) pageList[j].selected = true;
          } else {
            if (!e.ctrlKey && !e.metaKey) clearSelection();
            pageList[idx].selected = !pageList[idx].selected;
            lastSelectedIndex = idx;
          }
          renderAll(); updateControls();
        };
        const container = i.area === 'thumbnails' ? thumbnails : staging;
        container.appendChild(el);
        observer.observe(el);
      });
      setupSortable(thumbnails, 'thumbnails');
      setupSortable(staging, 'staging');
    }

    function setupSortable(container, areaKey) {
      if (container._sortable) container._sortable.destroy();
      container._sortable = Sortable.create(container, {
        animation: 150,
        group: 'pdfpages',
        multiDrag: true,
        multiDragKey: '',
        selectedClass: 'selected',
        onAdd: evt => {
          const items = evt.items.length ? evt.items : [evt.item];
          items.forEach(it => { const idx = +it.dataset.idx; pageList[idx].area = areaKey; pageList[idx].selected = false; });
          saveUndoState(); syncOrder(); renderAll(); updateControls();
        },
        onEnd: () => { saveUndoState(); syncOrder(); renderAll(); updateControls(); }
      });
    }

    function syncOrder() {
      const arr = [];
      [thumbnails, staging].forEach(c => Array.from(c.children).forEach(ch => arr.push(pageList[+ch.dataset.idx])));
      pageList = arr;
    }

    async function exportPagesAsPDF(pages, name) {
      try {
        const out = await PDFDocument.create(), origs = [];
        for (const f of fileList) {
          try { const b = await f.arrayBuffer(); origs.push(await PDFDocument.load(b)); } catch { origs.push(null); }
        }
        for (const it of pages) {
          if (it.isBlank) out.addPage([595, 842]);
          else if (it.fileType === 'pdf' && it.fileIdx >= 0 && origs[it.fileIdx]) {
            const [copiedPage] = await out.copyPages(origs[it.fileIdx], [it.pageNum - 1]);
            if (it.rotation) copiedPage.setRotation(degrees(it.rotation));
            out.addPage(copiedPage);
          } else if (it.fileType === 'img') {
            const b64 = it.dataURL.split(',')[1];
            const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
            const imgObj = it.dataURL.startsWith('data:image/png') ? await out.embedPng(bytes) : await out.embedJpg(bytes);
            const { width, height } = imgObj.scale(1);
            const page = out.addPage([width, height]);
            page.drawImage(imgObj, { x: 0, y: 0, width, height });
          }
        }
        const bytes = await out.save();
        const blob = new Blob([bytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}.pdf`;
        a.click();
        URL.revokeObjectURL(url);
        alert('âœ… åŒ¯å‡ºå®Œæˆ');
      } catch (e) { console.error(e); alert('âŒ åŒ¯å‡ºéŒ¯èª¤'); }
    }

    // ç¶å®šäº‹ä»¶
    insertBlankBtn.onclick        = insertBlankPage;
    undoBtn.onclick               = undoLastAction;
    zoomIn.onclick                = () => { scalePercent = Math.min(scalePercent + 10, 300); qualityInput.value = scalePercent; renderAll(); };
    zoomOut.onclick               = () => { scalePercent = Math.max(scalePercent - 10, 10); qualityInput.value = scalePercent; renderAll(); };
    qualityInput.onchange         = () => { let v = parseInt(qualityInput.value); if (isNaN(v) || v < 10) v = 10; v = Math.min(v, 300); scalePercent = v; qualityInput.value = v; renderAll(); };
    gapRange.oninput              = _ => document.querySelectorAll('.container').forEach(c => c.style.gap = gapRange.value + 'px');
    rotateLeftBtn.onclick         = () => { saveUndoState(); pageList.forEach(p => { if (p.selected) p.rotation = (p.rotation - 90 + 360) % 360; }); renderAll(); updateControls(); };
    rotateRightBtn.onclick        = () => { saveUndoState(); pageList.forEach(p => { if (p.selected) p.rotation = (p.rotation + 90) % 360; }); renderAll(); updateControls(); };
    moveLeftBtn.onclick           = () => {
      saveUndoState();
      // å…ˆåˆ†åˆ¥å– thumbnails èˆ‡ staging
      const arrThumb = pageList.filter(i => i.area === 'thumbnails');
      const arrStage = pageList.filter(i => i.area === 'staging');
      // è‹¥æœ‰åœ¨ thumbnails ä¸­é¸å–ï¼Œå°±å° thumbnails æ’åº
      if (arrThumb.some(i => i.selected)) {
        for (let i = 0; i < arrThumb.length; i++) {
          if (arrThumb[i].selected && i > 0 && !arrThumb[i - 1].selected) {
            const tmp = arrThumb[i - 1]; arrThumb[i - 1] = arrThumb[i]; arrThumb[i] = tmp;
          }
        }
      }
      // è‹¥æ²’æœ‰ thumbnail çš„é¸å–ï¼Œä½†æœ‰ staging çš„é¸å–ï¼Œå‰‡å° staging æ’åº
      else if (arrStage.some(i => i.selected)) {
        for (let i = 0; i < arrStage.length; i++) {
          if (arrStage[i].selected && i > 0 && !arrStage[i - 1].selected) {
            const tmp = arrStage[i - 1]; arrStage[i - 1] = arrStage[i]; arrStage[i] = tmp;
          }
        }
      }
      pageList = [].concat(arrThumb, arrStage);
      renderAll();
      updateControls();
    };
    moveRightBtn.onclick          = () => {
      saveUndoState();
      const arrThumb = pageList.filter(i => i.area === 'thumbnails');
      const arrStage = pageList.filter(i => i.area === 'staging');
      if (arrThumb.some(i => i.selected)) {
        for (let i = arrThumb.length - 1; i >= 0; i--) {
          if (arrThumb[i].selected && i < arrThumb.length - 1 && !arrThumb[i + 1].selected) {
            const tmp = arrThumb[i + 1]; arrThumb[i + 1] = arrThumb[i]; arrThumb[i] = tmp;
          }
        }
      } else if (arrStage.some(i => i.selected)) {
        for (let i = arrStage.length - 1; i >= 0; i--) {
          if (arrStage[i].selected && i < arrStage.length - 1 && !arrStage[i + 1].selected) {
            const tmp = arrStage[i + 1]; arrStage[i + 1] = arrStage[i]; arrStage[i] = tmp;
          }
        }
      }
      pageList = [].concat(arrThumb, arrStage);
      renderAll();
      updateControls();
    };
    moveToStagingBtn.onclick      = () => { saveUndoState(); pageList.forEach(p => { if (p.selected && p.area === 'thumbnails') { p.area = 'staging'; p.selected = false; } }); renderAll(); updateControls(); };
    moveToThumbnailsBtn.onclick   = () => { saveUndoState(); pageList.forEach(p => { if (p.selected && p.area === 'staging') { p.area = 'thumbnails'; p.selected = false; } }); renderAll(); updateControls(); };
    deleteSelectedBtn.onclick     = () => { saveUndoState(); pageList = pageList.filter(i => !i.selected); renderAll(); updateControls(); };
    clearSelectBtn.onclick        = clearSelection;
    exportBtn.onclick             = async () => { const name = outputName.value.trim() || `output_${Date.now()}`; const pages = pageList.filter(i => i.area === 'thumbnails'); if (!pages.length) return alert('â— æœªé¸é é¢'); await exportPagesAsPDF(pages, name); };

    document.addEventListener('keydown', e => {
      // å¿«é€Ÿéµï¼šCtrl+Z / Cmd+Z â†’ å¾©åŸ
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
        e.preventDefault(); undoLastAction();
        return;
      }
      // Delete â†’ åˆªé™¤é¸å–
      if (e.key === 'Delete') {
        e.preventDefault(); saveUndoState(); pageList = pageList.filter(i => !i.selected); renderAll(); updateControls();
        return;
      }
      const anySelectedThumb = pageList.some(i => i.selected && i.area === 'thumbnails');
      const anySelectedStage = pageList.some(i => i.selected && i.area === 'staging');
      // â† / â†’ï¼šå€å…§æ’åº
      if (e.key === 'ArrowLeft') {
        if (anySelectedThumb || anySelectedStage) {
          e.preventDefault(); moveLeftBtn.click();
        }
        return;
      }
      if (e.key === 'ArrowRight') {
        if (anySelectedThumb || anySelectedStage) {
          e.preventDefault(); moveRightBtn.click();
        }
        return;
      }
      // â†‘ï¼šåƒ…é‡å° staging å€é¸å–ï¼Œç§»å› thumbnails
      if (e.key === 'ArrowUp' && anySelectedStage) {
        e.preventDefault(); moveToThumbnailsBtn.click();
        return;
      }
      // â†“ï¼šåƒ…é‡å° thumbnails å€é¸å–ï¼Œç§»åˆ° staging
      if (e.key === 'ArrowDown' && anySelectedThumb) {
        e.preventDefault(); moveToStagingBtn.click();
        return;
      }
    });

    // åˆå§‹æ¸²æŸ“
    renderAll();
    updateControls();
  </script>
</body>
</html>
